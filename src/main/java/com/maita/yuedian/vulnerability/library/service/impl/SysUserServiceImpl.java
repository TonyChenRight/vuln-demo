package com.maita.yuedian.vulnerability.library.service.impl;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.crypto.digest.DigestUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.maita.yuedian.vulnerability.library.config.SystemConfig;
import com.maita.yuedian.vulnerability.library.domain.SysRole;
import com.maita.yuedian.vulnerability.library.domain.SysUser;
import com.maita.yuedian.vulnerability.library.enums.StatusType;
import com.maita.yuedian.vulnerability.library.mapper.SysUserMapper;
import com.maita.yuedian.vulnerability.library.model.R;
import com.maita.yuedian.vulnerability.library.model.UserInfo;
import com.maita.yuedian.vulnerability.library.model.account.UpdateOwnPasswordParam;
import com.maita.yuedian.vulnerability.library.model.dict.UserSelect;
import com.maita.yuedian.vulnerability.library.model.user.UserEditParam;
import com.maita.yuedian.vulnerability.library.model.user.UserPage;
import com.maita.yuedian.vulnerability.library.model.user.UserPageParam;
import com.maita.yuedian.vulnerability.library.model.user.UserStatusParam;
import com.maita.yuedian.vulnerability.library.service.SysRoleService;
import com.maita.yuedian.vulnerability.library.service.SysUserService;
import jakarta.annotation.Resource;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.stream.Collectors;

/**
* @author tonychen
* @description 针对表【sys_user(用户表)】的数据库操作Service实现
* @createDate 2024-10-20 19:59:50
*/
@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser>
    implements SysUserService {

    @Resource
    private SystemConfig systemConfig;
    @Resource
    private SysRoleService sysRoleService;

    @Override
    public SysUser queryByAccount(String account) {
        LambdaQueryWrapper<SysUser> queryWrapper = Wrappers.lambdaQuery(SysUser.class)
                .eq(SysUser::getAccount, account);
        List<SysUser> users = list(queryWrapper);
        if (CollUtil.isEmpty(users) || users.get(0) == null) {
            return null;
        }
        return users.get(0);
    }

    @Override
    public R<IPage<UserPage>> userPage(UserPageParam param) {
        // 数据权限处理
        LambdaQueryWrapper<SysUser> queryWrapper = Wrappers.lambdaQuery(SysUser.class)
                .like(StrUtil.isNotBlank(param.getName()), SysUser::getName, param.getName())
                .eq(param.getId() != null, SysUser::getId, param.getId())
                .eq(StrUtil.isNotBlank(param.getAccount()), SysUser::getAccount, param.getAccount())
                .eq(StrUtil.isNotBlank(param.getRoleCode()), SysUser::getRoleCode, param.getRoleCode())
                .eq(param.getStatus() != null, SysUser::getStatus, param.getStatus())
                .orderByDesc(SysUser::getUpdatedTime);
        IPage<SysUser> listPage =super.page(new Page<>(param.getCurrent(), param.getSize()), queryWrapper);
        Map<String, String> roleCodeToNameMap = sysRoleService.list().stream().collect(Collectors.toMap(SysRole::getCode, SysRole::getName));
        return R.ok(listPage.convert(e -> new UserPage(e, roleCodeToNameMap)));
    }

    @Override
    public R<Long> userEdit(UserEditParam param, UserInfo opUser) {
        Long id = param.getId();
        SysUser checkAccountUser = this.queryByAccount(param.getAccount());
        if(checkAccountUser != null && !Objects.equals(checkAccountUser.getId(), id)){
            return R.error("此账号已存在");
        }

        if (id == null) {
            String genPassword = DigestUtil.md5Hex(systemConfig.getGenPassword());
            SysUser user = SysUser.buildByCreate(param, genPassword, opUser);
            save(user);
            return R.ok(user.getId());
        }

        SysUser sysUser = getById(id);
        if (sysUser == null) {
            return R.error("用户不存在");
        }

        SysUser user =SysUser.buildByUpdate(param, opUser);
        updateById(user);
        return R.ok(user.getId());
    }

    @Override
    public R<Long> userStatus(UserStatusParam param, UserInfo opUser) {
        SysUser user = getById(param.getId());
        if (user == null) {
            return R.error("用户不存在");
        }

        user.setStatus(param.getStatus());
        user.setUpdaterId(opUser.getUserId());
        user.setUpdaterName(opUser.getName());
        user.setUpdatedTime(System.currentTimeMillis());
        updateById(user);
        return R.ok(user.getId());
    }

    @Override
    public R<Long> userResetPassword(Long id, UserInfo opUser) {
        SysUser user = getById(id);
        if (user == null) {
            return R.error("用户不存在");
        }

        String genPassWord = systemConfig.getGenPassword();
        user.setPassword(DigestUtil.md5Hex(genPassWord));
        user.setUpdaterId(opUser.getUserId());
        user.setUpdaterName(opUser.getName());
        user.setUpdatedTime(System.currentTimeMillis());
        user.setNeedUpdatePwd(StatusType.ENABLE.getVal());
        updateById(user);
        return R.ok(user.getId());
    }

    @Override
    public R<Long> userUpdateOwnPassword(UserInfo userInfo, UpdateOwnPasswordParam param) {
        SysUser user = getById(userInfo.getUserId());
        if (user == null) {
            return R.error("用户不存在");
        }
        String oldPassword = DigestUtil.md5Hex(param.getOldPassword());
        if (!StrUtil.equals(user.getPassword(), oldPassword)) {
            return R.error("旧密码不正确");
        }

        user.setPassword(DigestUtil.md5Hex(param.getNewPassword()));
        user.setUpdaterId(userInfo.getUserId());
        user.setUpdaterName(userInfo.getName());
        user.setUpdatedTime(System.currentTimeMillis());
        user.setNeedUpdatePwd(StatusType.DISABLE.getVal());
        updateById(user);
        return R.ok(user.getId());
    }
}




