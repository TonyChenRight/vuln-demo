package com.maita.yuedian.vulnerability.library.utils;

import cn.hutool.core.date.DateTime;
import cn.hutool.core.date.DateUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.crypto.digest.DigestUtil;
import cn.hutool.http.HttpRequest;
import com.alibaba.fastjson2.JSONObject;
import com.maita.yuedian.vulnerability.library.model.R;
import lombok.extern.slf4j.Slf4j;

import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;

@Slf4j
public class SignatureUtil {

    private static final String KEY_ID = "keyId";
    private static final String TIMESTAMP = "timestamp";
    private static final String SIGNATURE = "signature";

    public static Map<String, String> buildSignatureHeaders(String keyId, String secretKey) {
        Map<String, String> headers = new HashMap<>();
        headers.put(KEY_ID, keyId);
        String timestamp = DateUtil.format(DateTime.now(), DateTimeFormatter.ISO_LOCAL_DATE_TIME);
        headers.put(TIMESTAMP, timestamp);
        headers.put(SIGNATURE, DigestUtil.md5Hex(secretKey + timestamp));
        return headers;
    }

    public static void main(String[] args) {
        String url = "http://119.45.169.164/auto-test/apis/ai/vu_scan/callback";
        Map<String, String> headers =new HashMap<>();
        headers.put("Content-Type", "application/json");
        Map<String, String> buildSignatureHeaders = SignatureUtil.buildSignatureHeaders("urf130lvzhn8j7iq", "2espftay156vd7rujickhwnqb93x04mz");
        headers.putAll(buildSignatureHeaders);

        Map<String, Object> map = new HashMap<>();
        log.info("SignatureUtil.main url: {}, data: {}", url, JSONObject.toJSONString(map));
        String body = HttpRequest.post(url)
                .timeout(60000)
                .body(JSONObject.toJSONString(map))
                .addHeaders(headers)
                .execute()
                .body();
        if (StrUtil.isBlank(body)) {
            log.error("响应为空");
        }
        log.info("AutoTestClient.checkAuth 响应结果：{}", body);
    }
}
