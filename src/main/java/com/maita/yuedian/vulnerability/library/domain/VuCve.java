package com.maita.yuedian.vulnerability.library.domain;

import cn.hutool.core.util.StrUtil;
import com.alibaba.fastjson2.JSON;
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.maita.yuedian.vulnerability.library.model.UserInfo;
import com.maita.yuedian.vulnerability.library.model.cve.CveFileEntry;
import com.maita.yuedian.vulnerability.library.model.cve.CveFileEntryAffect;
import com.maita.yuedian.vulnerability.library.utils.FieldUtils;
import lombok.Getter;
import lombok.Setter;
import lombok.experimental.Accessors;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

/**
 * <p>
 * CVE漏洞表
 * </p>
 *
 * @author jason
 * @since 2024-12-03
 */
@Getter
@Setter
@Accessors(chain = true)
@TableName("vu_cve")
public class VuCve implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ID
     */
    @TableId(value = "id", type = IdType.AUTO)
    private Long id;

    /**
     * 编号
     */
    @TableField("code")
    private String code;

    /**
     * 名称
     */
    @TableField("name")
    private String name;

    /**
     * 描述
     */
    @TableField("remark")
    private String remark;

    /**
     * 级别 1-低危 2-中危 3-高危 4-超危
     */
    @TableField("level")
    private Integer level;

    /**
     * 评分
     */
    @TableField("score")
    private String score;

    /**
     * 修复方式
     */
    @TableField("repair_methods")
    private String repairMethods;

    /**
     * 影响平台
     */
    @TableField("affect_range")
    private String affectRange;

    /**
     * 状态
     */
    @TableField("state")
    private String state;

    /**
     * 发布时间
     */
    @TableField("publish_time")
    private Long publishTime;

    /**
     * 更新时间
     */
    @TableField("modify_time")
    private Long modifyTime;

    /**
     * 创建时间
     */
    @TableField("created_time")
    private Long createdTime;

    /**
     * 更新时间
     */
    @TableField("updated_time")
    private Long updatedTime;

    /**
     * 创建人ID
     */
    @TableField("creator_id")
    private Long creatorId;

    /**
     * 更新人ID
     */
    @TableField("updater_id")
    private Long updaterId;

    /**
     * 创建人名称
     */
    @TableField("creator_name")
    private String creatorName;

    /**
     * 更新人名称
     */
    @TableField("updater_name")
    private String updaterName;



    public static VuCve buildForUpdate(VuCve vuCve, CveFileEntry fileEntry, UserInfo userInfo) {
        FieldUtils.safeSet(fileEntry.getCode(), vuCve::setCode);
        FieldUtils.safeSet(fileEntry.getName(), vuCve::setName);
        FieldUtils.safeSet(fileEntry.getPublishTime(), vuCve::setPublishTime);
        FieldUtils.safeSet(fileEntry.getModifyTime(), vuCve::setModifyTime);
        FieldUtils.safeSet(fileEntry.getState(), vuCve::setState);

        FieldUtils.safeSet(fileEntry.getAffectRange(), vuCve::setAffectRangeList);
        FieldUtils.safeSet(fileEntry.getBaseScore(), vuCve::setScore);
        FieldUtils.safeSet(fileEntry.getLevel(), vuCve::setLevel);

        FieldUtils.safeSet(fileEntry.getRemark(), vuCve::setRemarkList);
        FieldUtils.safeSet(fileEntry.getRepairMethods(), vuCve::setRepairMethodList);
        vuCve.setUpdatedTime(System.currentTimeMillis());
        vuCve.setUpdaterId(userInfo.getUserId());
        return vuCve;
    }


    public static VuCve buildForInsert(CveFileEntry fileEntry, UserInfo user) {
        VuCve vuCve = new VuCve();
        FieldUtils.autoFill(fileEntry.getCode(), String.class, vuCve::setCode);
        FieldUtils.autoFill(fileEntry.getName(), String.class, vuCve::setName);
        FieldUtils.autoFill(fileEntry.getRemark(), List.class, vuCve::setRemarkList);
        FieldUtils.autoFill(fileEntry.getLevel(), Integer.class, vuCve::setLevel);
        FieldUtils.autoFill(fileEntry.getBaseScore(), String.class, vuCve::setScore);
        FieldUtils.autoFill(fileEntry.getRepairMethods(), List.class, vuCve::setRepairMethodList);
        FieldUtils.autoFill(fileEntry.getAffectRange(), List.class, vuCve::setAffectRangeList);
        FieldUtils.autoFill(fileEntry.getState(), String.class, vuCve::setState);
        FieldUtils.autoFill(fileEntry.getPublishTime(), Long.class, vuCve::setPublishTime);
        FieldUtils.autoFill(fileEntry.getModifyTime(), Long.class, vuCve::setModifyTime);

        long timeMillis = System.currentTimeMillis();
        vuCve.setCreatedTime(timeMillis);
        vuCve.setUpdatedTime(timeMillis);
        vuCve.setCreatorId(user.getUserId());
        vuCve.setUpdaterId(user.getUserId());
        vuCve.setCreatorName(user.getName());
        vuCve.setUpdaterName(user.getName());
        return vuCve;
    }


    public void setAffectRangeList(List<CveFileEntryAffect> affectRangeList) {
        this.affectRange = JSON.toJSONString(affectRangeList);
    }

    public void setRemarkList(List<String> remarkList) {
        this.remark = JSON.toJSONString(remarkList);
    }

    public void setRepairMethodList(List<String> repairMethods) {
        this.repairMethods = JSON.toJSONString(repairMethods);
    }

    public List<CveFileEntryAffect> getAffectRangeList() {
        if (StrUtil.isNotBlank(this.affectRange) && this.affectRange.startsWith("[") && this.affectRange.endsWith("]")) {
            return JSON.parseArray(this.affectRange, CveFileEntryAffect.class);
        }
        return new ArrayList<>();
    }

    public List<String> getRemarkList() {
        if (StrUtil.isNotBlank(this.remark) && this.remark.startsWith("[") && this.remark.endsWith("]")) {
            return JSON.parseArray(this.remark, String.class);
        }
        return new ArrayList<>();
    }

    public List<String> getRepairMethodList() {
        if (StrUtil.isNotBlank(this.repairMethods) && this.repairMethods.startsWith("[") && this.repairMethods.endsWith("]")) {
            return JSON.parseArray(this.repairMethods, String.class);
        }
        return new ArrayList<>();
    }
}
