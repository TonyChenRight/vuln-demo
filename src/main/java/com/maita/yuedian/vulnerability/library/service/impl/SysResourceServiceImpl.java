package com.maita.yuedian.vulnerability.library.service.impl;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.text.AntPathMatcher;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.maita.yuedian.vulnerability.library.config.SystemConfig;
import com.maita.yuedian.vulnerability.library.domain.SysResource;
import com.maita.yuedian.vulnerability.library.enums.ResourceType;
import com.maita.yuedian.vulnerability.library.mapper.SysResourceMapper;
import com.maita.yuedian.vulnerability.library.service.SysResourceService;
import jakarta.annotation.Resource;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;

/**
* @author tonychen
* @description 针对表【sys_resource(资源表)】的数据库操作Service实现
* @createDate 2024-10-20 19:59:50
*/
@Service
public class SysResourceServiceImpl extends ServiceImpl<SysResourceMapper, SysResource>
    implements SysResourceService {

    @Resource
    private SystemConfig systemConfig;

    @Override
    public Set<String> queryApisByRoleCode(String roleCode) {
        List<SysResource> permissions = baseMapper.getRoleResources(roleCode);
        return permissions.
                stream()
                .filter(e -> Objects.equals(ResourceType.API.getVal(), e.getType()))
                .map(SysResource::getUri)
                .collect(Collectors.toSet());
    }

    @Override
    public List<SysResource> queryResourcesByRoleCode(String roleCode) {
        return baseMapper.getRoleResources(roleCode);
    }

    @Override
    public boolean authorization(String requestUri, String roleCode) {
        List<String> skipPermissionPath = systemConfig.getSkipPermissionPath();
        if (!CollUtil.isEmpty(skipPermissionPath)) {
            for (String path : skipPermissionPath) {
                boolean match = new AntPathMatcher().match(path, requestUri);
                if (match) {
                    return true;
                }
            }
        }
        Set<String> userApis = queryApisByRoleCode(roleCode);
        if (CollUtil.isEmpty(userApis)) {
            return false;
        }
        for (String userApi : userApis) {
            boolean match = new AntPathMatcher().match(userApi, requestUri);
            if (match) {
                return true;
            }
        }
        return false;
    }
}




