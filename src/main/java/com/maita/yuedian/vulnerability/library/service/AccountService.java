package com.maita.yuedian.vulnerability.library.service;

import cn.hutool.core.util.StrUtil;
import cn.hutool.crypto.digest.DigestUtil;
import com.maita.yuedian.vulnerability.library.config.SystemConfig;
import com.maita.yuedian.vulnerability.library.constant.Codes;
import com.maita.yuedian.vulnerability.library.constant.RedisKeys;
import com.maita.yuedian.vulnerability.library.domain.SysResource;
import com.maita.yuedian.vulnerability.library.domain.SysRole;
import com.maita.yuedian.vulnerability.library.domain.SysUser;
import com.maita.yuedian.vulnerability.library.enums.StatusType;
import com.maita.yuedian.vulnerability.library.model.R;
import com.maita.yuedian.vulnerability.library.model.UserInfo;
import com.maita.yuedian.vulnerability.library.model.account.*;
import com.maita.yuedian.vulnerability.library.utils.AESUtil;
import com.maita.yuedian.vulnerability.library.utils.TokenUtil;
import jakarta.annotation.Resource;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;
import java.util.concurrent.TimeUnit;

@Slf4j
@Service
public class AccountService {
    @Resource
    private SysUserService userService;
    @Resource
    private RedisTemplate<String, Object> redisTemplate;
    @Resource
    private SystemConfig systemConfig;
    @Resource
    private SysResourceService sysResourceService;
    @Resource
    private SysRoleService sysRoleService;

    public R<LoginInfo> login(LoginParam param) {
        SysUser user = userService.queryByAccount(param.getUsername());
        if (user == null) {
            return R.error("用户不存在");
        }
        if (Objects.equals(user.getStatus(), StatusType.DISABLE.getVal())) {
            return R.error("用户已禁用");
        }
        String password = DigestUtil.md5Hex(param.getPassword());
        if (!Objects.equals(user.getPassword(), password)) {
            return R.error("账号或密码错误");
        }
        String encryptPwd = AESUtil.encrypt(param.getPassword(), "");
        String userToken = TokenUtil.uuidToken();
        SysRole sysRole = sysRoleService.selectRoleByCode(user.getRoleCode());
        UserInfo userInfo = UserInfo.builder()
                .userId(user.getId())
                .account(user.getAccount())
                .name(user.getName())
                .roleCode(user.getRoleCode())
                .roleName(sysRole == null ? "" : sysRole.getName())
                .userToken(userToken)
                .encryptPwd(encryptPwd)
                .loginTime(System.currentTimeMillis())
                .build();
        redisTemplate.opsForValue().set(RedisKeys.TOKEN_PREFIX + userToken, userInfo, systemConfig.getMaxTokenExpireSeconds(), TimeUnit.SECONDS);

        return R.ok(LoginInfo.builder()
                .token(userToken)
                .build());
    }

    public R<UserInfo> getUserInfo(String userToken) {
        if (StrUtil.isBlank(userToken)) {
            return R.error("user-token不能为空");
        }
        UserInfo userInfo = (UserInfo)redisTemplate.opsForValue().get(RedisKeys.TOKEN_PREFIX + userToken);
        return R.ok(userInfo);
    }

    public R<List<SysResource>> getPermission(String userToken) {
        R<UserInfo> result = getUserInfo(userToken);
        if (!result.isSuccess()) {
            return R.error(result.getCode(), result.getMessage());
        }
        UserInfo userInfo = result.getData();
        if (userInfo == null) {
            return R.error(Codes.REDIRECT, "请重新登录");
        }
        List<SysResource> permissions = sysResourceService.queryResourcesByRoleCode(userInfo.getRoleCode());
        return R.ok(permissions);
    }

    public R logout(String userToken) {
        if (StrUtil.isBlank(userToken)) {
            return R.error("user-token不能为空");
        }
        redisTemplate.delete(RedisKeys.TOKEN_PREFIX + userToken);
        return R.ok();
    }

    public R<Long> userUpdatePassword(String userToken, UpdateOwnPasswordParam param) {
        R<UserInfo> result = getUserInfo(userToken);
        if (!result.isSuccess()) {
            return R.error(result.getCode(), result.getMessage());
        }
        UserInfo userInfo = result.getData();
        if (userInfo == null) {
            return R.error(Codes.REDIRECT, "请重新登录");
        }
        if (!StrUtil.equals(param.getNewPassword(), param.getReNewPassword())) {
            return R.error("两次密码输入不一致");
        }
        if (StrUtil.equals(param.getOldPassword(), param.getNewPassword())) {
            return R.error("新密码不允许与旧密码一致");
        }
        return userService.userUpdateOwnPassword(userInfo, param);
    }

    public R<Boolean> checkUpdatePwd(String userToken) {
        R<UserInfo> result = getUserInfo(userToken);
        if (!result.isSuccess()) {
            return R.error(result.getCode(), result.getMessage());
        }
        UserInfo userInfo = result.getData();
        if (userInfo == null) {
            return R.error(Codes.REDIRECT, "请重新登录");
        }
        SysUser sysUser = userService.queryByAccount(userInfo.getAccount());
        if (sysUser == null) {
            return R.error("用户不存在");
        }
        return R.ok(sysUser.isUpdatePwdFlag());
    }

    public R<UserInfo> checkAuth(CheckAuthParam checkAuthParam) {
        String userToken = checkAuthParam.getUserToken();
        R<UserInfo> userInfoResult = getUserInfo(userToken);
        if (!userInfoResult.isSuccess()) {
            return R.error(userInfoResult.getCode(), userInfoResult.getMessage());
        }
        UserInfo userInfo = userInfoResult.getData();
        if (userInfo == null) {
            return R.error(Codes.REDIRECT, "无效token或已失效");
        }
        boolean authorization = sysResourceService.authorization(checkAuthParam.getRequestUri(), userInfo.getRoleCode());
        if (!authorization) {
            return R.error(Codes.UNAUTHORIZED, "接口无权限");
        }
        return R.ok(userInfo);
    }
}
