package com.maita.yuedian.vulnerability.library.service.helper;

import cn.hutool.core.date.DatePattern;
import cn.hutool.core.date.DateUtil;
import cn.hutool.core.net.URLEncodeUtil;
import cn.hutool.core.util.EscapeUtil;
import cn.hutool.core.util.StrUtil;
import com.maita.yuedian.vulnerability.library.config.SystemConfig;
import com.maita.yuedian.vulnerability.library.model.R;
import com.maita.yuedian.vulnerability.library.model.cnnvd.CnnvdFileEntry;
import jakarta.annotation.Resource;
import lombok.extern.slf4j.Slf4j;
import org.dom4j.Document;
import org.dom4j.Element;
import org.dom4j.Node;
import org.dom4j.io.SAXReader;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

@Slf4j
@Component
public class XmlParseHelper {

    @Resource
    private SystemConfig systemConfig;

    public R<List<CnnvdFileEntry>> parseCnnvdEntryList(MultipartFile file) {
        try {
            String filterXml = filterXml(file);
            List<CnnvdFileEntry> entryList = new ArrayList<>();
            SAXReader reader = new SAXReader();
            Document document = reader.read(new ByteArrayInputStream(filterXml.getBytes(StandardCharsets.UTF_8)));
            Element rootElement = document.getRootElement();
            List<Element> elements = rootElement.elements();
            for (Element element : elements) {
                String name = getNodeText("name", element);
                String code = getNodeText("vuln-id", element);
                String published = getNodeText("published", element);
                String modified = getNodeText("modified", element);
                String severity = getNodeText("severity", element);
                String type = getNodeText("vuln-type", element);
                String desc = getNodeText("vuln-descript", element);
                String cveCode = getNodeText("other-id/cve-id", element);

                CnnvdFileEntry entry = new CnnvdFileEntry();
                entry.setName(name);
                entry.setCode(code);
                entry.setPublished(published);
                entry.setModified(modified);
                entry.setType(type);
                entry.setSeverity(severity);
                entry.setDesc(desc);
                entry.setCveCode(cveCode);

                entryList.add(entry);
            }
            return R.ok(entryList);
        }catch (Exception e) {
            log.error("parseCnnvdEntryList error", e);
            return R.error("解析XML失败");
        }
    }

    private String getNodeText(String path, Element element) {
        Node singleNode = element.selectSingleNode(path);
        return singleNode == null ? null : singleNode.getText();
    }

    private String filterXml(MultipartFile file) throws Exception {
        String originalFilename = file.getOriginalFilename();
        if (StrUtil.isBlank(originalFilename)) {
            throw new Exception("文件名为空");
        }
        String genFileName = genFileName(originalFilename);
        log.info("filterXml file , 原始文件名: {}, 原始文件大小: {}, 生成文件名: {}", file.getOriginalFilename(), file.getSize(), genFileName);

        // 写入本地
        File directory = new File(systemConfig.getUploadTmpPath());
        if (!directory.exists()) {
            directory.mkdirs();
        }
        File tmpFile = new File(systemConfig.getUploadTmpPath(), genFileName(file.getOriginalFilename()));
        file.transferTo(tmpFile);

        List<String> allLines = Files.readAllLines(tmpFile.toPath(), StandardCharsets.UTF_8);
        StringBuilder sb = new StringBuilder();
        List<String> escapeTags = Arrays.asList("name", "vuln-type", "vuln-descript");
        for (String line : allLines) {
            if (StrUtil.isBlank(line)) {
                continue;
            }
            for (String escapeTag : escapeTags) {
                String beginTag = String.format("<%s>", escapeTag);
                if (line.contains(beginTag)) {
                    line = escapeText(line, escapeTag);
                    break;
                }
            }
            sb.append(line);
        }
        return sb.toString();
    }

    private String genFileName(String originalFilename) {
        // 中文名称转义
        originalFilename = URLEncodeUtil.encode(originalFilename);
        String name = originalFilename.substring(0, originalFilename.lastIndexOf("."));
        // 文件名过长截断
        if (name.length() > 200) {
            name = name.substring(0, 200);
        }
        String suffix = originalFilename.substring(originalFilename.lastIndexOf("."));
        return String.format("%s_%s%s", name, DateUtil.format(new Date(), DatePattern.PURE_DATETIME_MS_FORMATTER), suffix);
    }

    private String escapeText(String line, String tag) {
        String beginTag = String.format("<%s>", tag);
        int tagLen = beginTag.length();
        String endTag = String.format("</%s>", tag);
        int beginIdx = line.indexOf(beginTag);
        int endIdx = line.indexOf(endTag);
        var txt = line.substring(beginIdx+tagLen, endIdx);
        txt = EscapeUtil.escapeXml(txt);
        return  line.substring(0, beginIdx+tagLen) + txt + line.substring(endIdx);
    }

    public static void main(String[] args) {
        String line = "    <name>WordPress plugin WP Cerber Security, Anti-spam & Malware Scan 安全漏洞</name>";
        int beginIdx = line.indexOf("<name>");
        int endIdx = line.indexOf("</name>");
        var txt = line.substring(beginIdx+6, endIdx);
        txt = EscapeUtil.escapeXml(txt);
        line = line.substring(0, beginIdx+6) + txt + line.substring(endIdx);
        System.out.println(line);
    }
}
