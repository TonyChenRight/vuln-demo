package com.maita.yuedian.vulnerability.library.controller.admin;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.maita.yuedian.vulnerability.library.aspect.annotations.LogInject;
import com.maita.yuedian.vulnerability.library.constant.LogModule;
import com.maita.yuedian.vulnerability.library.context.UserContext;
import com.maita.yuedian.vulnerability.library.model.IdParam;
import com.maita.yuedian.vulnerability.library.model.ImportResult;
import com.maita.yuedian.vulnerability.library.model.R;
import com.maita.yuedian.vulnerability.library.model.cnnvd.CnnvdEditParam;
import com.maita.yuedian.vulnerability.library.model.cnnvd.CnnvdPage;
import com.maita.yuedian.vulnerability.library.model.cnnvd.CnnvdPageParam;
import com.maita.yuedian.vulnerability.library.model.custom.CustomEditParam;
import com.maita.yuedian.vulnerability.library.model.custom.CustomPage;
import com.maita.yuedian.vulnerability.library.model.custom.CustomPageParam;
import com.maita.yuedian.vulnerability.library.model.cve.CvePage;
import com.maita.yuedian.vulnerability.library.model.cve.CvePageParam;
import com.maita.yuedian.vulnerability.library.service.VuCnnvdService;
import com.maita.yuedian.vulnerability.library.service.VuCustomService;
import com.maita.yuedian.vulnerability.library.service.VuCveService;
import com.maita.yuedian.vulnerability.library.utils.FieldUtils;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.annotation.Resource;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

@Validated
@Tag(name = "漏洞管理")
@RestController
@RequestMapping("/admin/vulnerability")
public class VulnerabilityAdminController {

    @Resource
    private VuCnnvdService vuCnnvdService;
    @Resource
    private VuCveService vuCveService;
    @Resource
    private VuCustomService vuCustomService;

    @Operation(summary = "CNNVD--列表/查看")
    @GetMapping("/cnnvd/page")
    public R<IPage<CnnvdPage>> cnnvdPage(@Validated CnnvdPageParam param) {
        param.setKeyword(FieldUtils.filterLikeCharacter(param.getKeyword()));
        param.setName(FieldUtils.filterLikeCharacter(param.getName()));
        return vuCnnvdService.cnnvdPage(param);
    }

    @LogInject(module = LogModule.CNNVD, type = "CNNVD导入")
    @Operation(summary = "CNNVD--导入")
    @PostMapping(value = "/cnnvd/import", headers="content-type=multipart/form-data")
    public R<ImportResult> cnnvdImport(@RequestParam("file") @RequestPart("file") MultipartFile file) {
        return vuCnnvdService.cnnvdImport(file, UserContext.getUser());
    }

    @LogInject(module = LogModule.CNNVD, type = "CNNVD编辑")
    @Operation(summary = "CNNVD--编辑")
    @PostMapping("/cnnvd/edit")
    public R<Long> cnnvdEdit(@Validated @RequestBody CnnvdEditParam param) {
        return vuCnnvdService.cnnvdEdit(param, UserContext.getUser());
    }

    @Operation(summary = "CVE--列表/查看")
    @GetMapping("/cve/page")
    public R<IPage<CvePage>> cvePage(@Validated CvePageParam param) {
        param.setKeyword(FieldUtils.filterLikeCharacter(param.getKeyword()));
        param.setName(FieldUtils.filterLikeCharacter(param.getName()));
        return vuCveService.cvePage(param);
    }

    @LogInject(module = LogModule.CVE, type = "CVE导入")
    @Operation(summary = "CVE--导入")
    @PostMapping(value = "/cve/import", headers="content-type=multipart/form-data")
    public R<ImportResult> cveImport(@RequestParam("file") @RequestPart("file") MultipartFile file) {
        return vuCveService.cveImport(file, UserContext.getUser());
    }

    @Operation(summary = "自定义--列表/查看")
    @GetMapping("/custom/page")
    public R<IPage<CustomPage>> customPage(@Validated CustomPageParam param) {
        param.setKeyword(FieldUtils.filterLikeCharacter(param.getKeyword()));
        param.setName(FieldUtils.filterLikeCharacter(param.getName()));
        return vuCustomService.customPage(param);
    }

    @LogInject(module = LogModule.CUSTOM, type = "自定义编辑")
    @Operation(summary = "自定义--新增/编辑")
    @PostMapping("/custom/edit")
    public R<Long> customEdit(@Validated @RequestBody CustomEditParam param) {
        return vuCustomService.customEdit(param, UserContext.getUser());
    }

    @LogInject(module = LogModule.CUSTOM, type = "自定义删除")
    @Operation(summary = "自定义--删除")
    @PostMapping("/custom/delete")
    public R<Long> customEdit(@Validated @RequestBody IdParam param) {
        return vuCustomService.customDelete(param.getId());
    }

    @LogInject(module = LogModule.CUSTOM, type = "自定义导入")
    @Operation(summary = "自定义--导入")
    @PostMapping(value = "/custom/import", headers="content-type=multipart/form-data")
    public R<ImportResult> customImport(@RequestParam("file") @RequestPart("file") MultipartFile file) {
        return vuCustomService.customImport(file, UserContext.getUser());
    }

}
