package com.maita.yuedian.vulnerability.library.aspect;

import com.alibaba.fastjson2.JSON;
import com.maita.yuedian.vulnerability.library.aspect.annotations.LogInject;
import com.maita.yuedian.vulnerability.library.context.UserContext;
import com.maita.yuedian.vulnerability.library.domain.SysOperationLog;
import com.maita.yuedian.vulnerability.library.model.UserInfo;
import com.maita.yuedian.vulnerability.library.service.SysOperationLogService;
import com.maita.yuedian.vulnerability.library.utils.HttpContextUtils;
import com.maita.yuedian.vulnerability.library.utils.IPUtils;
import jakarta.annotation.Resource;
import jakarta.servlet.http.HttpServletRequest;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@Aspect
@Component
public class OperationLogAspect {

    @Resource
    private SysOperationLogService sysOperationLogService;

    @Around("@annotation(com.maita.yuedian.vulnerability.library.aspect.annotations.LogInject)")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        boolean success = true;
        Object result = null;
        String errMsg = "";
        Exception exception = null;
        try {
            result = point.proceed();
        }catch (Exception e){
            log.error("OperationLogAspect around : ", e);
            errMsg = e.getMessage();
            success = false;
            exception = e;
        }

        HttpServletRequest request = HttpContextUtils.getHttpServletRequest();
        log.info("OperationLogAspect 记录日志 => {}", request.getRequestURI());

        Method method = ((MethodSignature) point.getSignature()).getMethod();
        Object[] params = point.getArgs();
        LogInject annotation = method.getAnnotation(LogInject.class);
        SysOperationLog operationLog=new SysOperationLog();
        operationLog.setModule(annotation.module());
        operationLog.setType(annotation.type());
        operationLog.setParam(clearParams(params));
        operationLog.setUri(request.getRequestURI());
        operationLog.setIp(IPUtils.getIpAddr(request));
        operationLog.setSuccess(success);
        operationLog.setErrMsg(errMsg);
        UserInfo user = UserContext.getUser();
        if (user != null) {
            operationLog.setCreatorId(user.getUserId());
            operationLog.setCreatorName(user.getName());
        }
        operationLog.setCreatedTime(System.currentTimeMillis());
        sysOperationLogService.save(operationLog);
        log.info("OperationLogAspect 保存日志: {}", JSON.toJSONString(operationLog));

        if (!success) {
            throw exception;
        }

        return result;
    }

    private String clearParams(Object[] params) {
        List<Object> list =new ArrayList<>();
        for (Object param : params) {
            String name = param.getClass().getSimpleName();
            if (name.contains("ResponseFacade") || name.contains("HttpServletResponse") || name.contains("HttpServletRequest") || name.contains("StandardMultipartFile")) {
                continue;
            }
            list.add(param);
        }
        return JSON.toJSONString(list);
    }
}
